---
// Background Music Component with Mute Toggle
---

<div id="music-controls" class="fixed bottom-6 right-6 z-50">
  <button
    id="music-toggle"
    class="bg-[#0a0f0a]/90 backdrop-blur-sm border border-primary-green/30 rounded-full p-3 hover:bg-[#0a0f0a] hover:border-primary-green transition-all duration-300 group"
    aria-label="Toggle background music"
  >
    <svg id="music-icon-playing" class="w-6 h-6 text-primary-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18V5l12-2v13" />
      <circle cx="6" cy="18" r="3" />
      <circle cx="18" cy="16" r="3" />
    </svg>
    <svg id="music-icon-muted" class="w-6 h-6 text-gray-500 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18V5l12-2v13" />
      <circle cx="6" cy="18" r="3" />
      <circle cx="18" cy="16" r="3" />
      <line x1="1" y1="1" x2="23" y2="23" />
    </svg>
  </button>
</div>

<audio id="background-music" loop preload="auto">
  <source src="/audio/main-menu-theme.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>

<style>
  #music-controls {
    animation: fadeIn 1s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #music-toggle:hover svg {
    transform: scale(1.1);
  }

  #music-toggle svg {
    transition: transform 0.2s ease;
  }
</style>

<script>
  // Background Music Controller
  class BackgroundMusicController {
    constructor() {
      this.audio = document.getElementById('background-music') as HTMLAudioElement
      this.toggleBtn = document.getElementById('music-toggle')
      this.playingIcon = document.getElementById('music-icon-playing')
      this.mutedIcon = document.getElementById('music-icon-muted')

      // Get saved preference from localStorage
      this.isMuted = localStorage.getItem('bgMusicMuted') === 'true'

      this.init()
    }

    init() {
      if (!this.audio || !this.toggleBtn) return

      // Set initial state
      this.audio.volume = 0.3 // 30% volume
      this.updateUI()

      // Try to autoplay (will only work after user interaction)
      this.tryAutoplay()

      // Toggle button click handler
      this.toggleBtn.addEventListener('click', () => this.toggle())

      // Handle page visibility changes (pause when tab is hidden)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.audio.pause()
        } else if (!this.isMuted) {
          this.audio.play().catch(() => {
            // Autoplay prevented, user needs to interact
          })
        }
      })
    }

    async tryAutoplay() {
      if (this.isMuted) {
        return
      }

      try {
        await this.audio.play()
      } catch (error) {
        // Autoplay prevented by browser policy
        // Music will start when user clicks the toggle
        console.log('Autoplay prevented. Click the music button to start.')
      }
    }

    toggle() {
      this.isMuted = !this.isMuted
      localStorage.setItem('bgMusicMuted', this.isMuted.toString())

      if (this.isMuted) {
        this.audio.pause()
      } else {
        this.audio.play().catch(() => {
          console.error('Failed to play audio')
        })
      }

      this.updateUI()
    }

    updateUI() {
      if (this.isMuted) {
        this.playingIcon?.classList.add('hidden')
        this.mutedIcon?.classList.remove('hidden')
      } else {
        this.playingIcon?.classList.remove('hidden')
        this.mutedIcon?.classList.add('hidden')
      }
    }
  }

  // Initialize on page load
  if (typeof window !== 'undefined') {
    // Wait for user interaction before attempting to play
    let musicController: BackgroundMusicController | null = null

    const initMusic = () => {
      if (!musicController) {
        musicController = new BackgroundMusicController()
        // Remove the event listener after first interaction
        document.removeEventListener('click', initMusic)
      }
    }

    // Initialize on first click anywhere on the page
    document.addEventListener('click', initMusic, { once: true })
  }
</script>
